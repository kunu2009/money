<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#264653">
    <meta name="background-color" content="#264653">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="7K Money">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="7K Money">
    <meta name="msapplication-TileColor" content="#264653">
    <meta name="description" content="A powerful personal finance tracker with AI-powered transaction processing">
    <title>7K Money - Personal Finance Tracker</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDAiIGZpbGw9IiMyNjQ2NTMiLz4KPHR5cGUgeD0iNDgiIHk9IjExNiIgZmlsbD0iRkZGRkZGIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSI2NHB4IiBmb250LXdlaWdodD0iYm9sZCI+N0s8L3R5cGU+CjxzdmcgeD0iNDgiIHk9IjQ4IiB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0Y0QTI2MSI+CjxwPgo8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnpNMTEuNSA5SDUxM3YyaC0uNXYySDExVjloMW0xLjUgMGgxLjV2MmgtMS41Vjl6bTMtMmgxdjRoLTF6TTEzIDE2YzAgLjU1LjQ1IDEgMSAxcy0uNDUgMS0xLS0uNDUtMS0xLTFjLS41NSAwLTEgLjQ1LTEgMXoiLz4KPC9zdmc+Cjwvc3ZnPg==">
    <style>
        :root {
            --gable-green: #264653;
            --timberwolf: #D5D5D5;
            --chathams-blue: #2A9D8F;
            --calypso: #E76F51;
            --sandy-brown: #F4A261;
            --pale-dogwood: #E9C46A;
            
            /* FontAwesome variables */
            --fa-style-family-brands: "Font Awesome 6 Brands";
            --fa-font-brands: normal 400 1em/1 "Font Awesome 6 Brands";
            --fa-font-regular: normal 400 1em/1 "Font Awesome 6 Free";
            --fa-style-family-classic: "Font Awesome 6 Free";
            --fa-font-solid: normal 900 1em/1 "Font Awesome 6 Free";
            
            /* Enhanced color palette */
            --primary-color: #4A90E2;
            --secondary-color: #7B68EE;
            --accent-color: #FF6B6B;
            --success-color: #4CAF50;
            --warning-color: #FFA726;
            --dark-bg: #1a1a2e;
            --sidebar-width: 100px;
            
            /* Enhanced shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.1);
            
            /* Light theme */
            --bg-primary: #ffffff;
            --bg-secondary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --hover-bg: #f9f9f9;
            --shadow: var(--shadow-md);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
            --hover-bg: #3a3a3a;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
            --gable-green: #4a9b8e;
            --chathams-blue: #4db8a8;
            --calypso: #ff8a6b;
            --sandy-brown: #ffb84d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
        }

        /* Allow text selection in inputs and content areas */
        input, textarea, .ai-response, .parsed-results {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* PWA specific styles */
        .pwa-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--chathams-blue);
            color: white;
            padding: 15px;
            display: none;
            z-index: 1001;
            text-align: center;
        }

        .pwa-banner.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .container {
            max-width: calc(100vw - 115px); /* Full width minus wider sidebar space */
            width: 100%;
            margin: 0;
            padding: 15px;
            padding-bottom: 80px; /* Space for potential install banner */
            box-sizing: border-box;
        }

        header {
            background: var(--gable-green);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-content {
            flex: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--chathams-blue);
            border-radius: 2px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid var(--chathams-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab-btn.active {
            background: var(--chathams-blue);
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 4px solid var(--chathams-blue);
        }

        .stat-card.income {
            border-left-color: var(--chathams-blue);
        }

        .stat-card.expense {
            border-left-color: var(--calypso);
        }

        .stat-card.lended {
            border-left-color: #8e44ad;
        }

        .stat-card.borrowed {
            border-left-color: #f39c12;
        }

        .stat-card.lending-balance {
            border-left-color: #16a085;
        }

        /* Right Sidebar Styles */
        .right-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-card);
            border-left: 2px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 20px 0;
        }

        .sidebar-items {
            display: flex;
            flex-direction: column;
            gap: 4px; /* Much smaller gap between icons */
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center; /* Center items instead of space-between */
            padding: 10px 0; /* Reduced padding */
        }

        .sidebar-item {
            width: 60px; /* Larger icon containers */
            height: 60px;
            background: var(--hover-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-item:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateX(-5px) scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .sidebar-item:hover .sidebar-icon {
            transform: scale(1.2);
            color: white;
        }

        .sidebar-item.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .sidebar-item.active .sidebar-icon {
            color: white;
        }

        .sidebar-icon {
            font-size: 24px; /* Larger icons */
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .theme-toggle-sidebar:hover {
            background: var(--warning-color) !important;
            border-color: var(--warning-color) !important;
        }

        /* Tooltip for sidebar items */
        .sidebar-item::before {
            content: attr(title);
            position: absolute;
            right: 70px; /* Adjusted for wider sidebar */
            background: var(--dark-bg);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: var(--shadow-md);
        }

        .sidebar-item:hover::before {
            opacity: 1;
            transform: translateX(-5px);
        }

        /* Show tooltip on touch devices */
        .sidebar-item:active::before {
            opacity: 1;
            transform: translateX(-5px);
        }

        /* Adjust container for wider sidebar */
        .container {
            margin-right: 95px; /* Increased margin for 80px sidebar + padding */
            max-width: 1200px;
            margin-left: auto;
            padding: 15px;
            padding-bottom: 80px; /* Space for potential install banner */
        }

        /* Lending transactions styles */
        .lended-row {
            background: rgba(142, 68, 173, 0.1);
        }

        .borrowed-row {
            background: rgba(243, 156, 18, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: var(--bg-card);
            color: var(--text-primary);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-height: 44px; /* iOS minimum touch target */
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--chathams-blue);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: monospace;
        }

        button {
            background: var(--chathams-blue);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px; /* iOS minimum touch target */
        }

        button:hover {
            background: #238177;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        button.danger {
            background: var(--calypso);
        }

        button.danger:hover {
            background: #d55d41;
        }

        .transaction-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--gable-green);
            color: white;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #1e3a45;
        }

        tr:hover {
            background: var(--hover-bg);
        }

        .income-row {
            background: rgba(42, 157, 143, 0.05);
        }

        .expense-row {
            background: rgba(231, 111, 81, 0.05);
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--chathams-blue);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .ai-response {
            background: var(--hover-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--chathams-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .help-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .ai-process-section {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            background: var(--hover-bg);
        }

        .process-btn {
            background: var(--sandy-brown);
            margin-top: 15px;
        }

        .process-btn:hover {
            background: #e69545;
        }

        .parsed-results {
            margin-top: 20px;
            padding: 15px;
            background: var(--hover-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .success-text {
            color: var(--chathams-blue);
            font-weight: 500;
        }

        .error-text {
            color: var(--calypso);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                max-width: calc(100vw - 85px); /* Full width minus wider mobile sidebar space */
                padding: 8px;
            }
            
            /* Optimize sidebar for mobile */
            .right-sidebar {
                width: 75px; /* Wider on mobile too */
                padding: 10px 0;
                border-left: 1px solid var(--border-color);
            }
            
            .sidebar-items {
                gap: 3px; /* Very tight spacing on mobile */
                padding: 8px 0;
                justify-content: center;
            }
            
            .sidebar-item {
                width: 50px; /* Good size for mobile */
                height: 50px;
                min-width: 44px;
                min-height: 44px;
                border-radius: 10px;
            }
            
            .sidebar-item:hover {
                transform: translateX(-3px) scale(1.05);
            }
            
            .sidebar-icon {
                font-size: 20px; /* Good size for mobile */
            }
            
            .sidebar-item::before {
                right: 60px; /* Adjusted for mobile sidebar width */
                font-size: 11px;
                padding: 4px 8px;
                border-radius: 4px;
            }
            
            /* Mobile-optimized header */
            header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            h1 {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }
            
            /* Mobile-optimized tabs */
            .tabs {
                justify-content: flex-start;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 5px 0;
                margin-bottom: 15px;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px 14px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Mobile dashboard grid */
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
                text-align: center;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            /* Mobile cards */
            .card {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            /* Mobile forms */
            .form-group {
                margin-bottom: 15px;
            }
            
            input, select, textarea, button {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 6px;
                min-height: 44px;
            }
            
            button {
                padding: 12px 20px;
                font-weight: 500;
            }
            
            /* Mobile tables */
            .transaction-table {
                font-size: 13px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 500px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .actions {
                flex-direction: column;
                gap: 4px;
                min-width: 80px;
            }
            
            .btn-small {
                width: 100%;
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Mobile modal */
            .modal-content {
                padding: 15px;
                width: 95%;
                max-width: 400px;
                margin: 20px auto;
            }
            
            /* Mobile AI sections */
            .ai-process-section {
                padding: 15px;
                margin-top: 15px;
            }
            
            textarea {
                min-height: 120px;
                font-size: 14px;
            }
            
            .help-text {
                font-size: 12px;
                line-height: 1.4;
            }
        }

        @media (max-width: 480px) {
            .container {
                max-width: calc(100vw - 70px); /* Full width minus compact sidebar space */
                padding: 5px;
            }
            
            /* Extra compact sidebar for small screens */
            .right-sidebar {
                width: 65px;
                padding: 8px 0;
            }
            
            .sidebar-items {
                gap: 2px; /* Minimal spacing */
                padding: 6px 0;
                justify-content: center;
            }
            
            .sidebar-item {
                width: 45px;
                height: 45px;
                min-width: 44px;
                min-height: 44px;
                border-radius: 8px;
            }
            
            .sidebar-item:hover {
                transform: translateX(-2px) scale(1.03);
            }
            
            .sidebar-icon {
                font-size: 18px;
            }
            
            .sidebar-item::before {
                right: 50px;
                font-size: 10px;
                padding: 3px 6px;
                border-radius: 3px;
            }
            
            /* Extra small screen optimizations */
            h1 {
                font-size: 1.2rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            .tab-btn {
                font-size: 11px;
                padding: 8px 10px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .card {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            input, select, textarea, button {
                padding: 10px;
                font-size: 15px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .btn-small {
                padding: 5px 6px;
                font-size: 10px;
            }
            
            .modal-content {
                padding: 12px;
                width: 98%;
            }
            
            .ai-process-section {
                padding: 10px;
            }
            
            textarea {
                min-height: 100px;
                font-size: 13px;
            }
        }

        /* Landscape phone optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .right-sidebar {
                width: 70px;
            }
            
            .container {
                max-width: calc(100vw - 80px); /* Full width minus landscape sidebar space */
            }
        }

        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .container {
                max-width: calc(100vw - 65px); /* Full width minus tiny sidebar space */
                padding: 3px;
            }
            
            .right-sidebar {
                width: 60px;
            }
            
            .sidebar-item {
                width: 40px;
                height: 40px;
                min-width: 40px;
                min-height: 40px;
            }
            
            .sidebar-icon {
                font-size: 16px;
            }
            
            h1 {
                font-size: 1.1rem;
            }
            
        /* Enhanced mobile touch support */
        @media (hover: none) and (pointer: coarse) {
            .sidebar-item:hover {
                transform: none;
            }
            
            .sidebar-item:active {
                transform: translateX(-3px) scale(1.05);
                background: var(--primary-color);
            }
            
            .sidebar-item:active .sidebar-icon {
                color: white;
            }
            
            .tab-btn:hover {
                transform: none;
            }
            
            .tab-btn:active {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }
            
            button:hover {
                transform: none;
            }
            
            button:active {
                transform: translateY(-1px);
                box-shadow: var(--shadow-sm);
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .container {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            
            .right-sidebar {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            
            input, select, textarea {
                -webkit-appearance: none;
                appearance: none;
                border-radius: 6px;
            }
        }

        /* Android Chrome specific optimizations */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            .sidebar-item {
                -webkit-tap-highlight-color: transparent;
            }
            
            .tab-btn {
                -webkit-tap-highlight-color: transparent;
            }
            
            button {
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <!-- Right-hand Icon Sidebar -->
    <div class="right-sidebar">
        <div class="sidebar-items">
            <div class="sidebar-item" onclick="switchTab('dashboard')" title="Dashboard">
                <span class="sidebar-icon">üìä</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('single-add')" title="Add Transaction">
                <span class="sidebar-icon">‚ûï</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('mass-add')" title="Mass Add">
                <span class="sidebar-icon">üìù</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('transactions')" title="View Transactions">
                <span class="sidebar-icon">üìã</span>
            </div>
            <div class="sidebar-item" onclick="showLendingManager()" title="Lending Manager">
                <span class="sidebar-icon">üí∞</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('ai-assistant')" title="AI Assistant">
                <span class="sidebar-icon">ü§ñ</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('settings')" title="Settings">
                <span class="sidebar-icon">‚öôÔ∏è</span>
            </div>
            <div class="sidebar-item theme-toggle-sidebar" onclick="toggleTheme()" title="Toggle Theme">
                <span class="sidebar-icon" id="sidebar-theme-icon">üåô</span>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <h1>üí∞ 7K Money</h1>
                <p>Your Personal Finance Tracker</p>
                <small style="opacity: 0.8; font-size: 0.75em;">v2.0.4 - Fixed API v1 Endpoint</small>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">üåô</span> Dark
                </button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('single-add')">‚ûï Add Transaction</button>
            <button class="tab-btn" onclick="switchTab('mass-add')">üìù Mass Add</button>
            <button class="tab-btn" onclick="switchTab('transactions')">üìã Transactions</button>
            <button class="tab-btn" onclick="switchTab('ai-assistant')">ü§ñ AI Assistant</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card income">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" id="total-income">‚Çπ0</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value" id="total-expenses">‚Çπ0</div>
                </div>
                <div class="stat-card lended">
                    <div class="stat-label">Money Lended</div>
                    <div class="stat-value" id="total-lended">‚Çπ0</div>
                </div>
                <div class="stat-card borrowed">
                    <div class="stat-label">Money Borrowed</div>
                    <div class="stat-value" id="total-borrowed">‚Çπ0</div>
                </div>
                <div class="stat-card balance">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" id="current-balance">‚Çπ0</div>
                </div>
                <div class="stat-card lending-balance">
                    <div class="stat-label">Lending Balance</div>
                    <div class="stat-value" id="lending-balance">‚Çπ0</div>
                </div>
            </div>

            <div class="card">
                <h2>Category Breakdown</h2>
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>

            <div class="card">
                <h2>Recent Transactions</h2>
                <div id="recent-transactions"></div>
            </div>
        </div>

        <!-- Single Add Tab -->
        <div id="single-add" class="tab-content">
            <div class="card">
                <h2>Add Single Transaction</h2>
                <form id="single-transaction-form">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" placeholder="e.g., Grocery shopping" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Type</label>
                        <select id="category" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                            <option value="lended">Lended (Money Given)</option>
                            <option value="borrowed">Borrowed (Money Received)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount (‚Çπ)</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                    </div>
                    <button type="submit">Add Transaction</button>
                </form>
            </div>
        </div>

        <!-- Mass Add Tab -->
        <div id="mass-add" class="tab-content">
            <div class="card">
                <h2>Mass Add Transactions</h2>
                <p class="help-text">Enter transactions one per line or paste unformatted finance logs for AI processing</p>
                
                <!-- Manual Format Section -->
                <div class="form-group">
                    <label for="mass-input">Manual Entry (Structured Format)</label>
                    <p class="help-text">Format: [Date] [Description] [Amount] - Examples: "15 Sep bought notebook 50" or "20 Sep received salary 2000"</p>
                    <textarea id="mass-input" placeholder="15 Sep bought notebook 50
20 Sep received pocket money 200
22 Sep paid rent 800
25 Sep coffee shop 15"></textarea>
                    <button onclick="parseMassTransactions()">Parse & Add All</button>
                </div>

                <!-- AI Processing Section -->
                <div class="ai-process-section">
                    <h3>ü§ñ AI-Powered Finance Log Processing</h3>
                    <p class="help-text">Paste your unformatted finance logs below. AI will extract transactions and convert them to structured format.</p>
                    
                    <div class="form-group">
                        <label for="ai-api-key-mass">Gemini API Key</label>
                        <input type="password" id="ai-api-key-mass" placeholder="Enter your Gemini API key (starts with AIzaSy...)">
                        <p class="help-text">
                            Free tier API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> 
                            (using Gemini Flash model for efficiency). 
                            <button type="button" onclick="testMassApiKey()" style="margin-left: 10px; background: var(--sandy-brown); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                Test Key
                            </button>
                        </p>
                        <div id="mass-api-test-result" style="margin-top: 5px; display: none; font-size: 12px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="unformatted-log">Unformatted Finance Log</label>
                        <textarea id="unformatted-log" placeholder="Yesterday I bought groceries for around ‚Çπ85 at the store. Last week received my salary of 32000 rupees. Paid electricity bill ‚Çπ1200. Coffee yesterday morning was ‚Çπ45. Petrol for bike on Monday was about ‚Çπ450..." style="min-height: 200px;"></textarea>
                    </div>
                    
                    <button class="process-btn" onclick="processWithAI()">
                        <span id="ai-process-text">ü§ñ Process with AI</span>
                    </button>
                    
                    <div id="ai-processing-results" class="parsed-results" style="display: none;"></div>
                </div>

                <div id="parse-results"></div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="card">
                <h2>All Transactions</h2>
                <div class="transaction-table">
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th onclick="sortTransactions('date')">Date ‚Üï</th>
                                <th onclick="sortTransactions('description')">Description ‚Üï</th>
                                <th onclick="sortTransactions('type')">Type ‚Üï</th>
                                <th onclick="sortTransactions('amount')">Amount ‚Üï</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Assistant Tab -->
        <div id="ai-assistant" class="tab-content">
            <div class="card">
                <h2>AI Financial Assistant</h2>
                <div class="form-group">
                    <label>
                        Enable AI Assistant
                        <label class="toggle-switch">
                            <input type="checkbox" id="ai-toggle" onchange="toggleAI()">
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div id="ai-config" style="display:none;">
                    <div class="form-group">
                        <label for="api-key">Gemini API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your Gemini API key (starts with AIzaSy...)">
                        <p class="help-text">
                            Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>. 
                            Make sure the API key has permission to use Gemini models.
                        </p>
                        <button type="button" onclick="testApiKey()" style="margin-top: 10px; background: var(--sandy-brown); font-size: 14px; padding: 8px 16px;">
                            üîß Test API Key
                        </button>
                        <div id="api-test-result" style="margin-top: 10px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="ai-query">Ask about your finances</label>
                        <textarea id="ai-query" placeholder="e.g., What are my spending trends? Where can I save money?"></textarea>
                    </div>
                    <button onclick="askAI()">Get AI Insights</button>
                    <div id="ai-response" class="ai-response" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Lending Manager Tab -->
        <div id="lending-manager" class="tab-content">
            <div class="card">
                <h2>üí∞ Lending Manager</h2>
                <p class="help-text">Track money you've lent to others and borrowed from them</p>
                
                <div class="dashboard-grid" style="margin-bottom: 30px;">
                    <div class="stat-card lended">
                        <div class="stat-label">Total Lended</div>
                        <div class="stat-value" id="lending-total-lended">‚Çπ0</div>
                    </div>
                    <div class="stat-card borrowed">
                        <div class="stat-label">Total Borrowed</div>
                        <div class="stat-value" id="lending-total-borrowed">‚Çπ0</div>
                    </div>
                    <div class="stat-card lending-balance">
                        <div class="stat-label">Net Lending</div>
                        <div class="stat-value" id="lending-net-balance">‚Çπ0</div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Active Lending Relationships</h3>
                    <div id="lending-relationships"></div>
                </div>

                <div class="form-group">
                    <h3>Recent Lending Transactions</h3>
                    <div class="transaction-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Person/Description</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lending-transactions-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>Settings & Backup</h2>
                <div class="form-group">
                    <h3>Export Data</h3>
                    <button onclick="exportData('csv')">Export as CSV</button>
                    <button onclick="exportData('json')">Export as JSON</button>
                </div>
                <div class="form-group">
                    <h3>Import Data</h3>
                    <input type="file" id="import-file" accept=".json,.csv">
                    <button onclick="importData()">Import</button>
                </div>
                <div class="form-group">
                    <h3>Clear Data</h3>
                    <button class="danger" onclick="clearAllData()">Clear All Transactions</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwa-banner" class="pwa-banner">
        <span>üì± Install 7K Money as an app for better experience!</span>
        <button class="install-btn" onclick="installPWA()">Install</button>
        <button class="install-btn" onclick="dismissInstallBanner()" style="margin-left: 5px;">Later</button>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2>Edit Transaction</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="edit-date">Date</label>
                    <input type="date" id="edit-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <input type="text" id="edit-description" required>
                </div>
                <div class="form-group">
                    <label for="edit-category">Type</label>
                    <select id="edit-category" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                        <option value="lended">Lended (Money Given)</option>
                        <option value="borrowed">Borrowed (Money Received)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-amount">Amount (‚Çπ)</label>
                    <input type="number" id="edit-amount" step="0.01" required>
                </div>
                <div class="actions">
                    <button type="submit">Save</button>
                    <button type="button" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Management
        let transactions = JSON.parse(localStorage.getItem('7k_transactions')) || [];
        let sortField = 'date';
        let sortDirection = 'desc';
        let deferredPrompt;
        let isInstalled = false;

        // Check if app is installed
        function checkIfInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                isInstalled = true;
                document.body.classList.add('installed');
            }
            
            if (navigator.standalone === true) {
                isInstalled = true;
                document.body.classList.add('installed');
            }
        }

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt fired');
            e.preventDefault();
            deferredPrompt = e;
            
            if (!isInstalled && !localStorage.getItem('7k_install_dismissed')) {
                setTimeout(() => {
                    showInstallBanner();
                }, 3000); // Show after 3 seconds
            }
        });

        window.addEventListener('appinstalled', (evt) => {
            console.log('App installed');
            isInstalled = true;
            hideInstallBanner();
            localStorage.setItem('7k_install_dismissed', 'true');
            
            // Show success message
            setTimeout(() => {
                alert('üéâ 7K Money has been installed successfully! You can now access it from your home screen.');
            }, 1000);
        });

        function showInstallBanner() {
            const banner = document.getElementById('pwa-banner');
            if (banner && deferredPrompt && !isInstalled) {
                banner.classList.add('show');
            }
        }

        function hideInstallBanner() {
            const banner = document.getElementById('pwa-banner');
            if (banner) {
                banner.classList.remove('show');
            }
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                        localStorage.setItem('7k_install_dismissed', 'true');
                    }
                    deferredPrompt = null;
                    hideInstallBanner();
                });
            }
        }

        function dismissInstallBanner() {
            hideInstallBanner();
            localStorage.setItem('7k_install_dismissed', 'true');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if app is installed
            checkIfInstalled();
            
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Load saved theme
            const savedTheme = localStorage.getItem('7k_theme') || 'light';
            setTheme(savedTheme);
            
            // Load saved API key for mass add
            const savedMassApiKey = localStorage.getItem('7k_gemini_mass_key');
            if (savedMassApiKey) {
                document.getElementById('ai-api-key-mass').value = savedMassApiKey;
            }
            
            // Load transactions
            updateDashboard();
            displayTransactions();
            
            // Setup form handlers
            document.getElementById('single-transaction-form').addEventListener('submit', handleSingleAdd);
            document.getElementById('edit-form').addEventListener('submit', handleEdit);
            
            // Handle URL hash for deep linking
            handleUrlHash();
        });

        // Handle deep linking
        function handleUrlHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(hash)) {
                switchTab(hash);
            }
        }

        window.addEventListener('hashchange', handleUrlHash);

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('7k_theme', theme);
            
            const themeIcon = document.getElementById('theme-icon');
            const sidebarThemeIcon = document.getElementById('sidebar-theme-icon');
            const themeBtn = document.querySelector('.theme-toggle');
            
            if (theme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                sidebarThemeIcon.textContent = '‚òÄÔ∏è';
                themeBtn.innerHTML = '<span id="theme-icon">‚òÄÔ∏è</span> Light';
            } else {
                themeIcon.textContent = 'üåô';
                sidebarThemeIcon.textContent = 'üåô';
                themeBtn.innerHTML = '<span id="theme-icon">üåô</span> Dark';
            }
        }

        // Tab Management
        function switchTab(tabName) {
            // Update URL hash for deep linking
            if (history.pushState) {
                history.pushState(null, null, '#' + tabName);
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the button that corresponds to this tab
            const targetBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
                btn.getAttribute('onclick').includes(tabName)
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Update sidebar active states
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find matching sidebar item
            const sidebarItem = Array.from(document.querySelectorAll('.sidebar-item')).find(item => {
                const onclick = item.getAttribute('onclick');
                return onclick && onclick.includes(tabName);
            });
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Refresh data when switching tabs
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'transactions') {
                displayTransactions();
            } else if (tabName === 'lending-manager') {
                updateDashboard(); // This will also update lending data
            }
        }

        // Single Transaction Add
        function handleSingleAdd(e) {
            e.preventDefault();
            
            const transaction = {
                id: Date.now(),
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                type: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value)
            };
            
            addTransaction(transaction);
            document.getElementById('single-transaction-form').reset();
            document.getElementById('date').valueAsDate = new Date();
            
            alert('Transaction added successfully!');
        }

        // Mass Transaction Parser
        async function processWithAI() {
            const apiKey = document.getElementById('ai-api-key-mass').value.trim();
            const unformattedLog = document.getElementById('unformatted-log').value.trim();
            
            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }
            
            // Validate API key format (basic check)
            if (!apiKey.startsWith('AIzaSy') && apiKey.length < 35) {
                alert('Invalid API key format. Please check your Gemini API key.');
                return;
            }
            
            if (!unformattedLog) {
                alert('Please enter some unformatted finance log text');
                return;
            }
            
            // Save API key
            localStorage.setItem('7k_gemini_mass_key', apiKey);
            
            const processBtn = document.querySelector('.process-btn');
            const processText = document.getElementById('ai-process-text');
            const resultsDiv = document.getElementById('ai-processing-results');
            
            // Show loading state
            processText.innerHTML = '<div class="loading"></div> Processing with AI...';
            processBtn.disabled = true;
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading"></div> AI is analyzing your finance log...';
            
            try {
                const prompt = `
Please analyze the following unformatted finance log and extract individual transactions. 
Return ONLY a JSON array of transactions in this exact format:
[
  {
    "date": "YYYY-MM-DD",
    "description": "description",
    "amount": number,
    "type": "income" or "expense" or "lended" or "borrowed"
  }
]

Rules:
1. Use today's date (${new Date().toISOString().split('T')[0]}) if no specific date is mentioned
2. If relative dates like "yesterday", "last week" are mentioned, calculate the actual date
3. Extract amounts as positive numbers only
4. Determine transaction type based on context:
   - "income": money received as salary, payment, etc.
   - "expense": money spent on purchases, bills, etc.
   - "lended": money given to someone (loan given)
   - "borrowed": money received from someone (loan taken)
5. Keep descriptions brief but descriptive
6. For lending transactions, include person's name in description if mentioned
7. Return ONLY the JSON array, no explanations

Finance Log:
${unformattedLog}
                `;
                
                // Call Gemini API with Flash model for efficiency
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 2048
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 400) {
                        throw new Error(`Invalid API key or request format: ${errorMessage}`);
                    } else if (response.status === 403) {
                        throw new Error('API key is invalid or doesn\'t have permission. Please verify your Gemini API key.');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please try again in a few minutes.');
                    } else {
                        throw new Error(`API Error: ${errorMessage}`);
                    }
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response from AI');
                }
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from response
                const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('No valid JSON found in AI response');
                }
                
                const extractedTransactions = JSON.parse(jsonMatch[0]);
                
                if (!Array.isArray(extractedTransactions)) {
                    throw new Error('AI response is not a valid array');
                }
                
                // Display results and add transactions
                let resultHtml = `<div class="success-text">‚úÖ AI processed ${extractedTransactions.length} transactions successfully!</div>`;
                resultHtml += `<h4>Extracted Transactions:</h4><ul>`;
                
                extractedTransactions.forEach((t, index) => {
                    // Add unique ID and validate data
                    t.id = Date.now() + index;
                    t.amount = parseFloat(t.amount);
                    
                    resultHtml += `<li>${t.date} - ${t.description} - ‚Çπ${t.amount.toFixed(2)} (${t.type})</li>`;
                    
                    // Add to transactions
                    addTransaction(t);
                });
                
                resultHtml += `</ul>`;
                resultHtml += `<div style="margin-top: 15px;"><button onclick="clearUnformattedLog()" style="background: var(--chathams-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Clear & Add More</button></div>`;
                
                resultsDiv.innerHTML = resultHtml;
                
            } catch (error) {
                console.error('AI Processing Error:', error);
                resultsDiv.innerHTML = `<div class="error-text">‚ùå Error: ${error.message}</div>
                    <p class="help-text">Please check your API key and try again. Make sure you're using a valid Gemini API key from Google AI Studio.</p>`;
            } finally {
                processText.innerHTML = 'ü§ñ Process with AI';
                processBtn.disabled = false;
            }
        }

        function clearUnformattedLog() {
            document.getElementById('unformatted-log').value = '';
            document.getElementById('ai-processing-results').style.display = 'none';
        }
        function parseMassTransactions() {
            const input = document.getElementById('mass-input').value;
            const lines = input.trim().split('\n');
            const results = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                try {
                    const parsed = parseTransactionLine(line);
                    if (parsed) {
                        results.push(parsed);
                    } else {
                        errors.push(`Line ${index + 1}: Could not parse "${line}"`);
                    }
                } catch (e) {
                    errors.push(`Line ${index + 1}: ${e.message}`);
                }
            });
            
            // Display results
            let resultHtml = `<div class="parsed-results">`;
            
            if (results.length > 0) {
                resultHtml += `<div class="success-text">‚úÖ Parsed ${results.length} transactions</div>`;
                resultHtml += `<ul>`;
                results.forEach(t => {
                    resultHtml += `<li>${t.date} - ${t.description} - ‚Çπ${t.amount} (${t.type})</li>`;
                });
                resultHtml += `</ul>`;
                
                // Add transactions
                results.forEach(t => {
                    t.id = Date.now() + Math.random();
                    addTransaction(t);
                });
                
                document.getElementById('mass-input').value = '';
            }
            
            if (errors.length > 0) {
                resultHtml += `<div class="error-text">‚ùå Errors</div>`;
                resultHtml += `<ul>`;
                errors.forEach(e => {
                    resultHtml += `<li style="color: var(--calypso);">${e}</li>`;
                });
                resultHtml += `</ul>`;
            }
            
            resultHtml += `</div>`;
            document.getElementById('parse-results').innerHTML = resultHtml;
        }

        function parseTransactionLine(line) {
            // Remove extra spaces and normalize
            line = line.trim().replace(/\s+/g, ' ');
            
            // Try different patterns
            // Pattern 1: "DD Mon description amount"
            // Pattern 2: "YYYY-MM-DD description amount"
            // Pattern 3: "MM/DD/YYYY description amount"
            
            const patterns = [
                /^(\d{1,2})\s+(\w{3})\s+(.+?)\s+(\d+(?:\.\d{2})?)$/i,
                /^(\d{4}-\d{2}-\d{2})\s+(.+?)\s+(\d+(?:\.\d{2})?)$/,
                /^(\d{1,2}\/\d{1,2}\/\d{4})\s+(.+?)\s+(\d+(?:\.\d{2})?)$/
            ];
            
            for (let pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    let date, description, amount;
                    
                    if (patterns.indexOf(pattern) === 0) {
                        // Format: DD Mon
                        const day = match[1].padStart(2, '0');
                        const month = getMonthNumber(match[2]);
                        const year = new Date().getFullYear();
                        date = `${year}-${month}-${day}`;
                        description = match[3];
                        amount = parseFloat(match[4]);
                    } else if (patterns.indexOf(pattern) === 1) {
                        // Format: YYYY-MM-DD
                        date = match[1];
                        description = match[2];
                        amount = parseFloat(match[3]);
                    } else {
                        // Format: MM/DD/YYYY
                        const [m, d, y] = match[1].split('/');
                        date = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                        description = match[2];
                        amount = parseFloat(match[3]);
                    }
                    
                    // Determine type based on keywords
                    const incomeKeywords = ['salary', 'income', 'received', 'earned', 'payment', 'refund'];
                    const lendedKeywords = ['lent', 'gave', 'lend', 'loan given'];
                    const borrowedKeywords = ['borrowed', 'took', 'loan', 'advance'];
                    
                    let type = 'expense'; // default
                    const desc = description.toLowerCase();
                    
                    if (lendedKeywords.some(k => desc.includes(k))) {
                        type = 'lended';
                    } else if (borrowedKeywords.some(k => desc.includes(k))) {
                        type = 'borrowed';
                    } else if (incomeKeywords.some(k => desc.includes(k))) {
                        type = 'income';
                    }
                    
                    return { date, description, amount, type };
                }
            }
            
            return null;
        }

        function getMonthNumber(monthName) {
            const months = {
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
            };
            return months[monthName.toLowerCase().substr(0, 3)] || '01';
        }

        // Transaction Management
        function addTransaction(transaction) {
            transactions.push(transaction);
            saveTransactions();
            updateDashboard();
            displayTransactions();
        }

        function saveTransactions() {
            localStorage.setItem('7k_transactions', JSON.stringify(transactions));
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDashboard();
                displayTransactions();
            }
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                document.getElementById('edit-id').value = transaction.id;
                document.getElementById('edit-date').value = transaction.date;
                document.getElementById('edit-description').value = transaction.description;
                document.getElementById('edit-category').value = transaction.type;
                document.getElementById('edit-amount').value = transaction.amount;
                document.getElementById('edit-modal').classList.add('active');
            }
        }

        function handleEdit(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-id').value);
            const index = transactions.findIndex(t => t.id === id);
            
            if (index !== -1) {
                transactions[index] = {
                    id: id,
                    date: document.getElementById('edit-date').value,
                    description: document.getElementById('edit-description').value,
                    type: document.getElementById('edit-category').value,
                    amount: parseFloat(document.getElementById('edit-amount').value)
                };
                saveTransactions();
                updateDashboard();
                displayTransactions();
                closeEditModal();
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Display Functions
        function updateDashboard() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const lended = transactions.filter(t => t.type === 'lended').reduce((sum, t) => sum + t.amount, 0);
            const borrowed = transactions.filter(t => t.type === 'borrowed').reduce((sum, t) => sum + t.amount, 0);
            
            // Net balance: income + borrowed - expenses - lended
            const balance = income + borrowed - expenses - lended;
            // Lending balance: money we expect to get back (lended - borrowed)
            const lendingBalance = lended - borrowed;
            
            document.getElementById('total-income').textContent = `‚Çπ${income.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `‚Çπ${expenses.toFixed(2)}`;
            document.getElementById('total-lended').textContent = `‚Çπ${lended.toFixed(2)}`;
            document.getElementById('total-borrowed').textContent = `‚Çπ${borrowed.toFixed(2)}`;
            document.getElementById('current-balance').textContent = `‚Çπ${balance.toFixed(2)}`;
            document.getElementById('lending-balance').textContent = `‚Çπ${lendingBalance.toFixed(2)}`;
            
            // Update lending manager dashboard
            const lendingTotalLended = document.getElementById('lending-total-lended');
            const lendingTotalBorrowed = document.getElementById('lending-total-borrowed');
            const lendingNetBalance = document.getElementById('lending-net-balance');
            
            if (lendingTotalLended) lendingTotalLended.textContent = `‚Çπ${lended.toFixed(2)}`;
            if (lendingTotalBorrowed) lendingTotalBorrowed.textContent = `‚Çπ${borrowed.toFixed(2)}`;
            if (lendingNetBalance) lendingNetBalance.textContent = `‚Çπ${lendingBalance.toFixed(2)}`;
            
            // Update recent transactions
            const recent = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            let recentHtml = '<ul style="list-style: none; padding: 0;">';
            recent.forEach(t => {
                const icons = {
                    'income': 'üí∞',
                    'expense': 'üí∏',
                    'lended': 'üí∏',
                    'borrowed': 'üí∞'
                };
                const icon = icons[t.type] || 'üí∏';
                recentHtml += `<li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                    ${icon} ${t.date} - ${t.description} - ‚Çπ${t.amount.toFixed(2)} (${t.type})
                </li>`;
            });
            recentHtml += '</ul>';
            document.getElementById('recent-transactions').innerHTML = recentHtml || '<p>No transactions yet</p>';
            
            // Update chart
            updateCategoryChart();
            
            // Update lending relationships
            updateLendingRelationships();
            updateLendingTransactions();
        }

        function updateCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            const ctx = canvas.getContext('2d');
            
            // Calculate category totals
            const categories = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const cat = t.description.split(' ')[0].toLowerCase();
                    categories[cat] = (categories[cat] || 0) + t.amount;
                }
            });
            
            // Simple bar chart
            const entries = Object.entries(categories).slice(0, 5);
            if (entries.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillText('No expense data to display', canvas.width / 2 - 60, canvas.height / 2);
                return;
            }
            
            const maxValue = Math.max(...entries.map(e => e[1]));
            const barWidth = canvas.width / (entries.length * 2);
            const scale = (canvas.height - 40) / maxValue;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#2A9D8F';
            
            entries.forEach((entry, index) => {
                const x = barWidth + (index * barWidth * 2);
                const height = entry[1] * scale;
                const y = canvas.height - height - 20;
                
                ctx.fillRect(x, y, barWidth, height);
                ctx.fillStyle = '#264653';
                ctx.fillText(entry[0], x, canvas.height - 5);
                ctx.fillText(`‚Çπ${entry[1].toFixed(0)}`, x, y - 5);
                ctx.fillStyle = '#2A9D8F';
            });
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-tbody');
            if (!tbody) return;
            
            const sorted = [...transactions].sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];
                
                if (sortField === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (sortField === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            tbody.innerHTML = sorted.map(t => `
                <tr class="${t.type}-row">
                    <td>${t.date}</td>
                    <td>${t.description}</td>
                    <td>${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</td>
                    <td>‚Çπ${t.amount.toFixed(2)}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-small" onclick="editTransaction(${t.id})">Edit</button>
                            <button class="btn-small danger" onclick="deleteTransaction(${t.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Lending Management Functions
        function showLendingManager() {
            switchTab('lending-manager');
        }

        function updateLendingRelationships() {
            const lendingDiv = document.getElementById('lending-relationships');
            if (!lendingDiv) return;
            
            // Group transactions by person/description for lending relationships
            const relationships = {};
            
            transactions.filter(t => t.type === 'lended' || t.type === 'borrowed').forEach(t => {
                const person = extractPersonName(t.description);
                if (!relationships[person]) {
                    relationships[person] = { lended: 0, borrowed: 0 };
                }
                relationships[person][t.type] += t.amount;
            });
            
            let html = '<div class="lending-relationships-grid" style="display: grid; gap: 15px; margin-top: 15px;">';
            
            Object.entries(relationships).forEach(([person, amounts]) => {
                const netAmount = amounts.lended - amounts.borrowed;
                const status = netAmount > 0 ? 'owes you' : netAmount < 0 ? 'you owe' : 'settled';
                const statusColor = netAmount > 0 ? '#16a085' : netAmount < 0 ? '#e74c3c' : '#95a5a6';
                
                html += `
                    <div class="relationship-card" style="background: var(--bg-card); padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <h4 style="margin: 0 0 10px 0;">${person}</h4>
                        <p style="margin: 5px 0; font-size: 14px;">Lended: ‚Çπ${amounts.lended.toFixed(2)}</p>
                        <p style="margin: 5px 0; font-size: 14px;">Borrowed: ‚Çπ${amounts.borrowed.toFixed(2)}</p>
                        <p style="margin: 10px 0 0 0; font-weight: bold; color: ${statusColor};">
                            ${status === 'settled' ? '‚úÖ All settled!' : `${status}: ‚Çπ${Math.abs(netAmount).toFixed(2)}`}
                        </p>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (Object.keys(relationships).length === 0) {
                html = '<p class="help-text">No lending relationships yet. Add some lended or borrowed transactions to see relationships here.</p>';
            }
            
            lendingDiv.innerHTML = html;
        }

        function updateLendingTransactions() {
            const tbody = document.getElementById('lending-transactions-tbody');
            if (!tbody) return;
            
            const lendingTransactions = transactions.filter(t => t.type === 'lended' || t.type === 'borrowed')
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = lendingTransactions.map(t => `
                <tr class="${t.type}-row">
                    <td>${t.date}</td>
                    <td>${t.description}</td>
                    <td>${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</td>
                    <td>‚Çπ${t.amount.toFixed(2)}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-small" onclick="editTransaction(${t.id})">Edit</button>
                            <button class="btn-small danger" onclick="deleteTransaction(${t.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function extractPersonName(description) {
            // Simple extraction - take first word or until common keywords
            const words = description.toLowerCase().split(' ');
            const stopWords = ['to', 'from', 'for', 'money', 'loan', 'lent', 'borrowed'];
            
            for (let i = 0; i < words.length; i++) {
                if (stopWords.includes(words[i])) {
                    return words.slice(0, i).join(' ') || 'Unknown';
                }
            }
            
            return words[0] || 'Unknown';
        }

        function sortTransactions(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            displayTransactions();
        }

        // Export/Import Functions
        function exportData(format) {
            let data, filename, type;
            
                if (format === 'json') {
                data = JSON.stringify(transactions, null, 2);
                filename = '7k_money_backup.json';
                type = 'application/json';
            } else if (format === 'csv') {
                data = 'Date,Description,Type,Amount(‚Çπ)\n';
                transactions.forEach(t => {
                    data += `${t.date},"${t.description}",${t.type},${t.amount}\n`;
                });
                filename = '7k_money_backup.csv';
                type = 'text/csv';
            }            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    if (file.name.endsWith('.json')) {
                        const imported = JSON.parse(content);
                        transactions = [...transactions, ...imported];
                        saveTransactions();
                        updateDashboard();
                        displayTransactions();
                        alert('Data imported successfully!');
                    } else if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n');
                        const header = lines[0];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const [date, description, type, amount] = lines[i].split(',');
                            transactions.push({
                                id: Date.now() + i,
                                date: date,
                                description: description.replace(/"/g, ''),
                                type: type,
                                amount: parseFloat(amount)
                            });
                        }
                        saveTransactions();
                        updateDashboard();
                        displayTransactions();
                        alert('CSV imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all transactions? This cannot be undone!')) {
                transactions = [];
                saveTransactions();
                updateDashboard();
                displayTransactions();
                alert('All data cleared');
            }
        }

        // AI Assistant Functions
        function toggleAI() {
            const isEnabled = document.getElementById('ai-toggle').checked;
            document.getElementById('ai-config').style.display = isEnabled ? 'block' : 'none';
            
            if (isEnabled) {
                const savedKey = localStorage.getItem('7k_gemini_key');
                if (savedKey) {
                    document.getElementById('api-key').value = savedKey;
                }
            }
        }

        async function askAI() {
            const apiKey = document.getElementById('api-key').value.trim();
            const query = document.getElementById('ai-query').value.trim();
            
            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }
            
            // Validate API key format (basic check)
            if (!apiKey.startsWith('AIzaSy') && apiKey.length < 35) {
                alert('Invalid API key format. Please check your Gemini API key.');
                return;
            }
            
            if (!query) {
                alert('Please enter a question');
                return;
            }
            
            // Save API key
            localStorage.setItem('7k_gemini_key', apiKey);
            
            const responseDiv = document.getElementById('ai-response');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading"></div> Analyzing your finances...';
            
            try {
                // Prepare transaction summary for AI
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = income - expenses;
                
                const transactionSummary = `
                    Total Income: ‚Çπ${income.toFixed(2)}
                    Total Expenses: ‚Çπ${expenses.toFixed(2)}
                    Current Balance: ‚Çπ${balance.toFixed(2)}
                    Number of Transactions: ${transactions.length}
                    Recent Transactions: ${JSON.stringify(transactions.slice(-10))}
                `;
                
                const prompt = `
                    As a financial advisor, analyze the following financial data and answer this question: "${query}"
                    
                    Financial Data:
                    ${transactionSummary}
                    
                    Please provide helpful, actionable advice.
                `;
                
                // Call Gemini API with better error handling
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 400) {
                        throw new Error(`Invalid API key or request format: ${errorMessage}`);
                    } else if (response.status === 403) {
                        throw new Error('API key is invalid or doesn\'t have permission. Please check your Gemini API key.');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please try again later.');
                    } else {
                        throw new Error(`API Error: ${errorMessage}`);
                    }
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response from AI. Please try again.');
                }
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                responseDiv.innerHTML = `<strong>AI Insights:</strong>\n\n${aiResponse}`;
            } catch (error) {
                console.error('AI Assistant Error:', error);
                responseDiv.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Test API Key for Mass Add
        async function testMassApiKey() {
            const apiKey = document.getElementById('ai-api-key-mass').value.trim();
            const testResult = document.getElementById('mass-api-test-result');
            
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }
            
            testResult.style.display = 'block';
            testResult.innerHTML = 'üîÑ Testing...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Test'
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    testResult.innerHTML = '<span style="color: green;">‚úÖ Valid</span>';
                    localStorage.setItem('7k_gemini_mass_key', apiKey);
                } else {
                    testResult.innerHTML = '<span style="color: red;">‚ùå Invalid</span>';
                }
            } catch (error) {
                testResult.innerHTML = '<span style="color: red;">‚ùå Error</span>';
            }
        }

        // API Key Testing Function
        async function testApiKey() {
            const apiKey = document.getElementById('api-key').value.trim();
            const testResult = document.getElementById('api-test-result');
            
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }
            
            testResult.style.display = 'block';
            testResult.innerHTML = '<div class="loading"></div> Testing API key...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Hello, respond with just "API key is working!"'
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates[0]) {
                        testResult.innerHTML = '<span style="color: green;">‚úÖ API key is valid and working!</span>';
                        localStorage.setItem('7k_gemini_key', apiKey);
                    } else {
                        testResult.innerHTML = '<span style="color: orange;">‚ö†Ô∏è API key works but response format unexpected.</span>';
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}`;
                    
                    if (response.status === 400) {
                        testResult.innerHTML = '<span style="color: red;">‚ùå Invalid API key format or request.</span>';
                    } else if (response.status === 403) {
                        testResult.innerHTML = '<span style="color: red;">‚ùå API key is invalid or lacks permissions.</span>';
                    } else {
                        testResult.innerHTML = `<span style="color: red;">‚ùå Error: ${errorMessage}</span>`;
                    }
                }
            } catch (error) {
                testResult.innerHTML = `<span style="color: red;">‚ùå Network error: ${error.message}</span>`;
            }
        }

        // Enhanced Service Worker for PWA with update checking
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates every time the app loads
                        registration.update();
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        console.log('New version available, prompting user...');
                                        if (confirm('üöÄ A new version is available! Would you like to refresh to get the latest features?')) {
                                            window.location.reload();
                                        } else {
                                            // Show a persistent update notification
                                            showUpdateNotification();
                                        }
                                    }
                                }
                            });
                        });
                        
                        // Periodically check for updates (every 30 minutes)
                        setInterval(() => {
                            registration.update();
                        }, 30 * 60 * 1000);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Show update notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: var(--chathams-blue); color: white; 
                           padding: 15px 20px; border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 9999;
                           font-size: 14px; max-width: 300px;">
                    üöÄ New version available! 
                    <button onclick="window.location.reload()" style="background: rgba(255,255,255,0.2); 
                           border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; 
                           border-radius: 4px; margin-left: 10px; cursor: pointer;">Update</button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; 
                           border: none; color: white; padding: 4px 8px; cursor: pointer; float: right;">√ó</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
    </script>
</body>
</html>